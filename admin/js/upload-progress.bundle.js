(()=>{(function(n){"use strict";var t={},a=null,g=0,c=0,l=!!window.OPTIPRESS_DEBUG;function f(){l&&window.console&&console.log&&console.log.apply(console,arguments)}function U(e){if(!e)return"";var s=e.toLowerCase().match(/\.([a-z0-9]+)$/);if(!s)return"";var i=window.optipressUpload&&window.optipressUpload.extensionMap||{},d=s[1];return i[d]||""}function h(e){return e?e.mime?e.mime:e.type&&e.subtype?(e.type+"/"+e.subtype).toLowerCase():U(e.filename||e.name||""):""}function x(e){if(!e)return!1;e=e.toLowerCase();var s=window.optipressUpload&&window.optipressUpload.supportedMimeTypes||[];return s.indexOf(e)!==-1}n(document).ready(function(){typeof wp=="undefined"||typeof wp.Uploader=="undefined"||(O(),y(),wp.Uploader.queue&&wp.Uploader.queue.on("add",function(e){e&&e.id&&(l&&f("OptiPress uploader queue add:",e),m(e.id,e))}),wp.Uploader.queue&&wp.Uploader.queue.on("upload:success",function(e){e&&e.id&&(l&&f("OptiPress uploader success:",e),m(e.id,e))}))});function m(e,s){var i=h(s);l&&f("OptiPress trackAttachment:",e,i,s),x(i)&&(t[e]={id:e,filename:s.filename||s.name||"image",attempts:0,maxAttempts:30,fastPollUntil:Date.now()+5e3},u(e,"processing"),b(e),a||P())}function P(){var e=0;a=setInterval(function(){e++,w(),e===10&&a&&(clearInterval(a),a=setInterval(w,1e3))},200)}function k(){a&&(clearInterval(a),a=null)}function w(){var e=Object.keys(t);if(e.length===0){k();return}e.forEach(function(s){var i=t[s];if(i.attempts++,i.attempts>=i.maxAttempts){u(s,"timeout"),delete t[s];return}b(s)})}function b(e){n.ajax({url:ajaxurl,type:"POST",data:{action:"optipress_check_conversion_status",nonce:optipressUpload.nonce,attachment_id:e},success:function(s){s.success&&s.data&&(s.data.status==="completed"?(u(e,"completed",s.data),delete t[e],S(s.data)):s.data.status==="processing"?u(e,"processing",s.data):s.data.status==="not_applicable"&&delete t[e])},error:function(){}})}function u(e,s,i){y(),_(e,s,i)}function S(e){e.bytes_saved&&e.bytes_saved>0&&(g+=e.bytes_saved,c++,M())}function O(){if(!n("#optipress-savings-counter").length){var e=n('<div id="optipress-savings-counter" class="optipress-counter-hidden"><div class="optipress-counter-label">OptiPress Session</div><div class="optipress-counter-value"><span id="optipress-session-savings">0 KB</span> saved</div><div class="optipress-counter-count"><span id="optipress-session-count">0</span> images optimized</div></div>');n("body").append(e)}}function y(){if(!n("#optipress-upload-panel").length){var e=n('<div id="optipress-upload-panel" class="hidden"><div class="optipress-upload-header"><span>OptiPress Uploads</span><button type="button" class="optipress-upload-remove" title="Hide" aria-label="Hide">\xD7</button></div><ul class="optipress-upload-list" id="optipress-upload-list"></ul></div>');e.on("click",".optipress-upload-remove",function(){n("#optipress-upload-panel").toggleClass("hidden")}),n("body").append(e)}}function v(){var e=n("#optipress-upload-list"),s=e.children().length>0;n("#optipress-upload-panel").toggleClass("hidden",!s)}function _(e,s,i){var d=n("#optipress-upload-list"),p=String(e),o=d.find('[data-id="'+p+'"]'),C=i&&i.filename||t[p]&&t[p].filename||"#"+p,r;switch(s){case"processing":r=i&&i.message||"Converting image...";break;case"completed":r=i&&i.message||"Conversion complete";break;case"timeout":r="Conversion taking longer than expected...";break}switch(o.length?o.find(".optipress-upload-message").text(r):(o=n('<li class="optipress-upload-item processing" data-id="'+p+'"><span class="status-icon"><span class="spinner is-active"></span></span><div class="optipress-upload-filename" title="'+C+'">'+C+'</div><div class="optipress-upload-message">'+r+"</div></li>"),d.prepend(o)),o.removeClass("processing completed timeout"),s){case"processing":o.addClass("processing"),o.find(".status-icon").html('<span class="spinner is-active"></span>');break;case"completed":o.addClass("completed"),o.find(".status-icon").html('<span class="dashicons dashicons-yes-alt"></span>'),setTimeout(function(){o.fadeOut(300,function(){n(this).remove(),v()})},8e3);break;case"timeout":o.addClass("timeout"),o.find(".status-icon").html('<span class="dashicons dashicons-warning"></span>'),setTimeout(function(){o.fadeOut(300,function(){n(this).remove(),v()})},5e3);break}v()}function M(){var e=n("#optipress-savings-counter");if(e.length){var s,i=g/1024;i>=1024?s=(i/1024).toFixed(1)+" MB":s=i.toFixed(1)+" KB",n("#optipress-session-savings").text(s),n("#optipress-session-count").text(c),c>0&&e.removeClass("optipress-counter-hidden")}}})(jQuery);})();
//# sourceMappingURL=upload-progress.bundle.js.map
