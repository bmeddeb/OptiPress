(()=>{(function(n){"use strict";var o={},a=null,f=0,u=0,d=!!window.OPTIPRESS_DEBUG;function v(){d&&window.console&&console.log&&console.log.apply(console,arguments)}function w(e){if(!e)return"";var s=e.toLowerCase().match(/\.([a-z0-9]+)$/);if(!s)return"";switch(s[1]){case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";default:return""}}function S(e){return e?e.mime?e.mime:e.type&&e.subtype?(e.type+"/"+e.subtype).toLowerCase():w(e.filename||e.name||""):""}function k(e){return e?(e=e.toLowerCase(),e==="image/jpeg"||e==="image/png"):!1}n(document).ready(function(){if(!(typeof wp=="undefined"||typeof wp.Uploader=="undefined")){O(),b();var e=wp.Uploader.prototype.success;wp.Uploader.prototype.success=function(s){e.apply(this,arguments),d&&v("OptiPress uploader success:",s),s&&s.id&&g(s.id,s)},wp.Uploader.queue&&wp.Uploader.queue.on("add",function(s){s&&s.id&&g(s.id,s)})}});function g(e,s){var i=S(s);d&&v("OptiPress trackAttachment:",e,i,s),k(i)&&(o[e]={id:e,filename:s.filename||s.name||"image",attempts:0,maxAttempts:30,fastPollUntil:Date.now()+5e3},l(e,"processing"),y(e),a||P())}function P(){var e=0;a=setInterval(function(){e++,m(),e===10&&a&&(clearInterval(a),a=setInterval(m,1e3))},200)}function U(){a&&(clearInterval(a),a=null)}function m(){var e=Object.keys(o);if(e.length===0){U();return}e.forEach(function(s){var i=o[s];if(i.attempts++,i.attempts>=i.maxAttempts){l(s,"timeout"),delete o[s];return}y(s)})}function y(e){n.ajax({url:ajaxurl,type:"POST",data:{action:"optipress_check_conversion_status",nonce:optipressUpload.nonce,attachment_id:e},success:function(s){s.success&&s.data&&(s.data.status==="completed"?(l(e,"completed",s.data),delete o[e],x(s.data)):s.data.status==="processing"?l(e,"processing",s.data):s.data.status==="not_applicable"&&delete o[e])},error:function(){}})}function l(e,s,i){b(),_(e,s,i)}function x(e){e.bytes_saved&&e.bytes_saved>0&&(f+=e.bytes_saved,u++,j())}function O(){if(!n("#optipress-savings-counter").length){var e=n('<div id="optipress-savings-counter" class="optipress-counter-hidden"><div class="optipress-counter-label">OptiPress Session</div><div class="optipress-counter-value"><span id="optipress-session-savings">0 KB</span> saved</div><div class="optipress-counter-count"><span id="optipress-session-count">0</span> images optimized</div></div>');n("body").append(e)}}function b(){if(!n("#optipress-upload-panel").length){var e=n('<div id="optipress-upload-panel" class="hidden"><div class="optipress-upload-header"><span>OptiPress Uploads</span><button type="button" class="optipress-upload-remove" title="Hide" aria-label="Hide">\xD7</button></div><ul class="optipress-upload-list" id="optipress-upload-list"></ul></div>');e.on("click",".optipress-upload-remove",function(){n("#optipress-upload-panel").toggleClass("hidden")}),n("body").append(e)}}function c(){var e=n("#optipress-upload-list"),s=e.children().length>0;n("#optipress-upload-panel").toggleClass("hidden",!s)}function _(e,s,i){var C=n("#optipress-upload-list"),p=String(e),t=C.find('[data-id="'+p+'"]'),h=i&&i.filename||o[p]&&o[p].filename||"#"+p,r;switch(s){case"processing":r=i&&i.message||"Converting image...";break;case"completed":r=i&&i.message||"Conversion complete";break;case"timeout":r="Conversion taking longer than expected...";break}switch(t.length?t.find(".optipress-upload-message").text(r):(t=n('<li class="optipress-upload-item processing" data-id="'+p+'"><span class="status-icon"><span class="spinner is-active"></span></span><div class="optipress-upload-filename" title="'+h+'">'+h+'</div><div class="optipress-upload-message">'+r+"</div></li>"),C.prepend(t)),t.removeClass("processing completed timeout"),s){case"processing":t.addClass("processing"),t.find(".status-icon").html('<span class="spinner is-active"></span>');break;case"completed":t.addClass("completed"),t.find(".status-icon").html('<span class="dashicons dashicons-yes-alt"></span>'),setTimeout(function(){t.fadeOut(300,function(){n(this).remove(),c()})},8e3);break;case"timeout":t.addClass("timeout"),t.find(".status-icon").html('<span class="dashicons dashicons-warning"></span>'),setTimeout(function(){t.fadeOut(300,function(){n(this).remove(),c()})},5e3);break}c()}function j(){var e=n("#optipress-savings-counter");if(e.length){var s,i=f/1024;i>=1024?s=(i/1024).toFixed(1)+" MB":s=i.toFixed(1)+" KB",n("#optipress-session-savings").text(s),n("#optipress-session-count").text(u),u>0&&e.removeClass("optipress-counter-hidden")}}})(jQuery);})();
//# sourceMappingURL=upload-progress.bundle.js.map
