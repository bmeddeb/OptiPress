(()=>{(function(t){"use strict";var f={statsRefreshTimer:null,init:function(){this.bindEvents(),this.debouncedLoadStats()},bindEvents:function(){t("#optipress-start-batch").on("click",this.startBatchConversion.bind(this)),t("#optipress-revert-batch").on("click",this.startRevert.bind(this)),t("#optipress-sanitize-svg-batch").on("click",this.startSvgSanitization.bind(this))},loadStats:function(){var s=this;t.ajax({url:ajaxurl,type:"POST",data:{action:"optipress_get_batch_stats",nonce:optipressAdmin.nonce},success:function(r){r.success&&s.updateStats(r.data)}})},debouncedLoadStats:function(){var s=this;this.statsRefreshTimer&&clearTimeout(this.statsRefreshTimer),this.statsRefreshTimer=setTimeout(function(){s.loadStats()},750)},updateStats:function(s){t("#optipress-total-images").text(s.total||0),t("#optipress-converted-images").text(s.converted||0),t("#optipress-remaining-images").text(s.remaining||0),t("#optipress-total-svgs").text(s.svg_total||0),s.remaining>0?t("#optipress-start-batch").prop("disabled",!1):t("#optipress-start-batch").prop("disabled",!0),s.converted>0?t("#optipress-revert-batch").prop("disabled",!1):t("#optipress-revert-batch").prop("disabled",!0),s.svg_total>0?t("#optipress-sanitize-svg-batch").prop("disabled",!1):t("#optipress-sanitize-svg-batch").prop("disabled",!0)},startBatchConversion:function(s){s.preventDefault();var r=function(){var e=parseInt(t("#optipress-remaining-images").text()),i=e;this.processBatch({action:"optipress_process_batch",resultKey:"processed",total:i,processed:0,offset:0,progressBar:"#optipress-batch-progress",statusText:"#optipress-batch-status",resultArea:"#optipress-batch-result",button:"#optipress-start-batch",successCallback:this.onBatchComplete.bind(this),progressText:optipressAdmin.i18n.processing,startTime:Date.now(),batchCount:0})}.bind(this);OptipressNotices.createConfirm(optipressAdmin.i18n.confirmBatch).then(function(e){e&&r()})},startRevert:function(s){s.preventDefault();var r=function(){var e=parseInt(t("#optipress-converted-images").text()),i=e;this.processBatch({action:"optipress_revert_images",resultKey:"reverted",total:i,processed:0,offset:0,progressBar:"#optipress-revert-progress",statusText:"#optipress-revert-status",resultArea:"#optipress-revert-result",button:"#optipress-revert-batch",successCallback:this.onRevertComplete.bind(this),progressText:optipressAdmin.i18n.reverting,startTime:Date.now(),batchCount:0})}.bind(this);OptipressNotices.createConfirm(optipressAdmin.i18n.confirmRevert).then(function(e){e&&r()})},startSvgSanitization:function(s){s.preventDefault();var r=function(){var e=parseInt(t("#optipress-total-svgs").text());this.processBatch({action:"optipress_sanitize_svg_batch",resultKey:"sanitized",total:e,processed:0,offset:0,progressBar:"#optipress-svg-batch-progress",statusText:"#optipress-svg-batch-status",resultArea:"#optipress-svg-batch-result",button:"#optipress-sanitize-svg-batch",successCallback:this.onSvgBatchComplete.bind(this),progressText:optipressAdmin.i18n.sanitizing,startTime:Date.now(),batchCount:0})}.bind(this);OptipressNotices.createConfirm(optipressAdmin.i18n.confirmSvgBatch).then(function(e){e&&r()})},processBatch:function(s){var r=this,e=t(s.progressBar),i=t(s.statusText),a=t(s.resultArea),o=t(s.button);o.prop("disabled",!0),s.processed===0&&(a.hide(),e.show().find(".optipress-progress-fill").css("width","0%"),i.show().removeClass("optipress-error optipress-success").text(s.progressText+" 0 / "+s.total+" (0%)")),s.batchCount++,this.processChunk(s,function(u,n){if(u){i.text(optipressAdmin.i18n.error+": "+u).addClass("optipress-error"),o.prop("disabled",!1);return}var v=n[s.resultKey]||0;s.processed+=v;var h=Math.min(100,Math.round(s.processed/s.total*100)),l=(Date.now()-s.startTime)/1e3,p="";if(s.processed>0){var m=l/s.processed,b=s.total-s.processed,c=Math.ceil(m*b);c>60?p=" (~"+Math.ceil(c/60)+" min remaining)":c>0&&(p=" (~"+c+" sec remaining)")}e.find(".optipress-progress-fill").css("width",h+"%");var g=s.progressText+" "+s.processed+" / "+s.total+" ("+h+"%)"+p;if(i.text(g),s.processed>=s.total||n.batch_size===0){var d=Math.ceil(l),C=d>60?Math.ceil(d/60)+" minutes":d+" seconds";i.text(optipressAdmin.i18n.complete+" "+s.processed+" / "+s.total+" (took "+C+")").removeClass("optipress-error").addClass("optipress-success"),o.prop("disabled",!1),s.successCallback&&s.successCallback(s.processed,a),setTimeout(function(){i.fadeOut(200,function(){t(this).text("").hide().removeClass("optipress-success")}),e.find(".optipress-progress-fill").css("width","0%"),e.fadeOut(200)},4e3),setTimeout(function(){r.debouncedLoadStats()},500)}else s.offset+=n.batch_size,setTimeout(function(){r.processBatch(s)},500)})},processChunk:function(s,r){t.ajax({url:ajaxurl,type:"POST",data:{action:s.action,nonce:optipressAdmin.nonce,offset:s.offset},success:function(e){e.success?r(null,e.data):r(e.data.message||optipressAdmin.i18n.unknownError)},error:function(e,i,a){r(a||optipressAdmin.i18n.unknownError)}})},showLocalSuccess:function(s,r){r.html('<div class="optipress-local-notice optipress-local-notice-success"><span class="dashicons dashicons-yes-alt"></span><span>'+s+"</span></div>").show(),setTimeout(function(){var e=r.find(".optipress-local-notice");e.fadeOut(200,function(){t(this).remove()})},4e3)},onBatchComplete:function(s,r){var e=optipressAdmin.i18n.batchComplete.replace("%d",s);if(this.showLocalSuccess(e,r),typeof wp!="undefined"&&wp.data&&wp.data.dispatch)try{wp.data.dispatch("core/notices").createNotice("success",e,{isDismissible:!0})}catch(i){}},onRevertComplete:function(s,r){var e=optipressAdmin.i18n.revertComplete.replace("%d",s);if(this.showLocalSuccess(e,r),typeof wp!="undefined"&&wp.data&&wp.data.dispatch)try{wp.data.dispatch("core/notices").createNotice("success",e,{isDismissible:!0})}catch(i){}},onSvgBatchComplete:function(s,r){var e=optipressAdmin.i18n.svgBatchComplete.replace("%d",s);if(this.showLocalSuccess(e,r),typeof wp!="undefined"&&wp.data&&wp.data.dispatch)try{wp.data.dispatch("core/notices").createNotice("success",e,{isDismissible:!0})}catch(i){}}};t(document).ready(function(){t(".optipress-batch-section").length>0&&f.init()})})(jQuery);})();
//# sourceMappingURL=batch-processor.bundle.js.map
